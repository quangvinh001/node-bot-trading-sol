<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solana Trading Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* C√°c n√∫t m·∫∑c ƒë·ªãnh */
        .action-btn {
            background-color: #2d3748;
            /* M√†u n·ªÅn m·∫∑c ƒë·ªãnh */
            color: #fdfdfd;
            /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Th√™m hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªïi */
        }

        /* M√†u n·ªÅn v√† m√†u ch·ªØ khi n√∫t ƒë∆∞·ª£c ch·ªçn */
        .action-btn.selected {
            background-color: #48bb78;
            /* M√†u n·ªÅn khi ch·ªçn (xanh l√°) */
            color: rgb(255, 255, 255);
            /* M√†u ch·ªØ khi ch·ªçn */
        }

        /* Hi·ªáu ·ª©ng hover cho n√∫t */
        .action-btn:hover {
            background-color: #38a169;
            /* M√†u n·ªÅn khi hover (xanh l√° ƒë·∫≠m h∆°n) */
            color: white;
            /* M√†u ch·ªØ khi hover */
        }

        /* M√†u n·ªÅn v√† m√†u ch·ªØ khi hover v√† n√∫t ƒë∆∞·ª£c ch·ªçn */
        .action-btn.selected:hover {
            background-color: #2f855a;
            /* M√†u n·ªÅn khi hover tr√™n n√∫t ƒë∆∞·ª£c ch·ªçn */
            color: white;
            /* M√†u ch·ªØ khi hover tr√™n n√∫t ƒë∆∞·ª£c ch·ªçn */
        }

        /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng tr√†n kh·ªèi khung */
        #transactionDetails {
            max-width: 430px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
            overflow-x: auto;
            /* Th√™m thanh cu·ªôn ngang n·∫øu n·ªôi dung v∆∞·ª£t qu√° khung */
            word-wrap: break-word;
            /* Ng·∫Øt d√≤ng n·∫øu n·ªôi dung qu√° d√†i */
            overflow-wrap: break-word;
        }

        #resultLog {
            max-width: 950px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
            overflow-x: auto;
            /* Th√™m thanh cu·ªôn ngang n·∫øu c·∫ßn */
            word-wrap: break-word;
            /* Ng·∫Øt d√≤ng cho chu·ªói d√†i */
            overflow-wrap: break-word;
            white-space: pre-wrap;
            /* Gi·ªØ kho·∫£ng c√°ch v√† xu·ªëng d√≤ng n·∫øu c·∫ßn */
        }

        /* CƒÉn ch·ªânh giao di·ªán g·ªçn g√†ng h∆°n */
        .transaction-item {
            padding: 10px;
            border: 1px solid #e5e7eb;
            /* Vi·ªÅn nh·∫π */
            border-radius: 5px;
            /* Bo g√≥c */
            margin-bottom: 10px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c giao d·ªãch */
            background-color: #f9fafb;
            /* N·ªÅn x√°m nh·∫°t */
        }

        .transaction-item p {
            margin: 5px 0;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
            word-wrap: break-word;
            /* Ng·∫Øt d√≤ng n·∫øu chu·ªói qu√° d√†i */
            overflow-wrap: break-word;
        }

        .transaction-item strong {
            color: #374151;
            /* M√†u ch·ªØ ƒë·∫≠m */
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Ph·∫ßn nh·∫≠p Private Keys v√† Th√¥ng S·ªë Giao D·ªãch -->
    <div class="container mx-auto p-6 flex-grow">
        <div class="flex flex-col space-y-6">
            <!-- N√∫t ·∫®n/Hi·ªán -->
            <div class="flex justify-between mb-4">
                <button id="toggleKeyFormButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">
                    ·∫®n/Hi·ªán Nh·∫≠p Private Keys
                </button>
                <button id="toggleThongSoFormButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">
                    ·∫®n/Hi·ªán Nh·∫≠p Th√¥ng S·ªë Giao D·ªãch
                </button>
            </div>

            <div class="flex space-x-5">
                <!-- Form Nh·∫≠p Private Keys -->
                <div id="keyForm" class="bg-white rounded-lg shadow-lg p-6 w-full">
                    <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">Nh·∫≠p Private Keys</h1>
                    <textarea id="privateKeys" rows="10" class="w-full p-2 border border-gray-300 rounded"
                        placeholder="Nh·∫≠p private keys (m·ªói key m·ªôt d√≤ng)"></textarea>
                    <br />
                    <button id="savePrivateKeys"
                        class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-700">L∆∞u Private
                        Keys</button>
                    <button id="getTokenButton"
                        class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-700">L·∫•y S·ªë L∆∞·ª£ng
                        Token</button>

                    <h1 class="text-2xl font-bold text-blue-600 mt-6">Hi·ªÉn Th·ªã Token</h1>
                    <div id="resultLog1"
                        class="bg-gray-50 border border-gray-300 p-4 rounded mt-4 overflow-y-auto max-h-40"></div>
                </div>

                <!-- Form Nh·∫≠p Th√¥ng S·ªë Giao D·ªãch -->
                <div id="thongSoForm" class="bg-white rounded-lg shadow-lg p-6 w-full">
                    <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">Nh·∫≠p Th√¥ng S·ªë Giao D·ªãch</h1>

                    <label for="key" class="font-semibold">L∆∞u Key: </label>
                    <select id="key" class="w-full p-2 border border-gray-300 rounded mb-4">
                        <!-- C√°c t√πy ch·ªçn s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                    </select>


                    <label for="action" class="font-semibold">Action (H√†nh ƒê·ªông buy/sell): </label>
                    <div id="action" class="grid grid-cols-2 gap-2 mb-4">
                        <button type="button" id="buyBtn"
                            class="action-btn p-2 text-center rounded bg-gray-800 text-gray-600" data-action="buy"
                            value="buy">Buy</button>
                        <button type="button" id="sellBtn"
                            class="action-btn p-2 text-center rounded bg-gray-800 text-gray-600" data-action="sell"
                            value="sell">Sell</button>
                    </div>


                    <label for="mint" class="font-semibold">Mint Address (ƒê·ªãa Ch·ªâ TOKEN): </label>
                    <input type="text" id="mint" class="w-full p-2 border border-gray-300 rounded mb-4" required />

                    <label for="denominatedInSol" class="font-semibold">DenominatedInSol (SOL/tokens): </label>
                    <select id="denominatedInSol" class="w-full p-2 border border-gray-300 rounded mb-4" required>
                        <option value="true">amount of SOL</option>
                        <option value="false">number of tokens</option>
                    </select>

                    <label for="amount" class="font-semibold">Amount (S·ªë L∆∞·ª£ng): </label>
                    <input type="number" step="any" id="amount" class="w-full p-2 border border-gray-300 rounded mb-2"
                        required />

                    <div id="tokenOutput" class="font-semibold mt-2"></div>

                    <div id="buyPercentages" class="hidden flex space-x-2 p-2 rounded-lg">
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0">reset</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0.1">0.1 SOL</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0.5">0.5 SOL</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="1">1 SOL</button>
                    </div>

                    <div id="sellPercentages" class="hidden flex space-x-2 p-2 rounded-lg">
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0">reset</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0.25">25%</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0.5">50%</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="0.75">75%</button>
                        <button class="text-xs px-3 py-1 rounded-md bg-[#1c1c24] text-gray-300 hover:bg-[#3a3a4a]"
                            data-percentage="1">100%</button>
                    </div>


                    <label for="slippage" class="font-semibold mt-4">Slippage (Tr∆∞·ª£t Gi√°): </label>
                    <input type="number" id="slippage" class="w-full p-2 border border-gray-300 rounded mb-4"
                        required />

                    <label for="priorityFee" class="font-semibold">Priority Fee (Ph√≠ ∆Øu): </label>
                    <input type="number" step="any" id="priorityFee"
                        class="w-full p-2 border border-gray-300 rounded mb-4" required />

                    <button id="saveThongSo" type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded mt-4 hover:bg-blue-700">L∆∞u Th√¥ng S·ªë Giao
                        D·ªãch</button>
                    <button id="clearAll" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700">
                        X√≥a h·∫øt th√¥ng s·ªë
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ph·∫ßn Th·ª±c Hi·ªán Giao D·ªãch -->
    <div class="container mx-auto p-6 flex-grow">
        <h1 class="text-2xl font-bold text-center text-blue-600 mb-4 w-full">Th·ª±c Hi·ªán Giao D·ªãch</h1>

        <div class="flex w-full space-x-3">

            <!-- Khu v·ª±c hi·ªÉn th·ªã th√¥ng s·ªë giao d·ªãch -->
            <div class="flex-1 bg-gray-50 p-6 rounded-lg shadow-lg border" style="flex: 3;">
                <h2 class="text-xl font-bold text-center text-blue-600">Th√¥ng S·ªë Giao D·ªãch</h2>
                <div id="transactionDetails" class="mt-4">
                    <!-- Th√¥ng s·ªë giao d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>

            <!-- Khu v·ª±c th·ª±c hi·ªán giao d·ªãch -->
            <div class="flex-1 bg-gray-50 p-6 rounded-lg shadow-lg border" style="flex: 7;">
                <button id="tradeButton"
                    class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full">Th·ª±c hi·ªán giao
                    d·ªãch</button>
                <h2 class="text-xl font-bold text-center mt-6">K·∫øt qu·∫£ giao d·ªãch</h2>
                <div id="resultLog"
                    class="bg-gray-50 border border-gray-300 p-4 rounded mt-4 overflow-y-auto max-h-40 w-full text-center">
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const keyDropdown = document.getElementById("key");

            if (!keyDropdown) {
                console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ dropdown v·ªõi id 'key'");
                return;
            }

            try {
                // G·ª≠i y√™u c·∫ßu ƒë·ªÉ l·∫•y danh s√°ch keys
                const response = await fetch("/params_key");
                console.log("ƒêang fetch danh s√°ch keys t·ª´ API /params_key");

                if (!response.ok) {
                    console.error("API tr·∫£ v·ªÅ l·ªói:", response.status, response.statusText);
                    return;
                }

                const keys = await response.json();
                console.log("Danh s√°ch keys nh·∫≠n ƒë∆∞·ª£c:", keys);

                // Th√™m t√πy ch·ªçn m·∫∑c ƒë·ªãnh "Key Full"
                const fullOption = document.createElement("option");
                fullOption.value = "keyfull";
                fullOption.textContent = "Key Full";
                keyDropdown.appendChild(fullOption);

                // Th√™m c√°c keys v√†o dropdown
                keys.forEach(key => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = key;
                    keyDropdown.appendChild(option);
                });

                console.log("ƒê√£ th√™m danh s√°ch keys v√†o dropdown");
            } catch (error) {
                console.error("L·ªói khi t·∫£i danh s√°ch keys:", error);
            }
        });
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ·∫©n/hi·ªán form
        function toggleVisibility(buttonId, formId, textWhenVisible, textWhenHidden) {
            const button = document.getElementById(buttonId);
            const form = document.getElementById(formId);
            form.classList.toggle("hidden");
            button.textContent = form.classList.contains("hidden") ? textWhenHidden : textWhenVisible;
        }

        document.getElementById("toggleKeyFormButton").addEventListener("click", function () {
            toggleVisibility("toggleKeyFormButton", "keyForm", "·∫®n Nh·∫≠p Private Keys", "Hi·ªán Nh·∫≠p Private Keys");
        });

        document.getElementById("toggleThongSoFormButton").addEventListener("click", function () {
            toggleVisibility("toggleThongSoFormButton", "thongSoForm", "·∫®n Nh·∫≠p Th√¥ng S·ªë Giao D·ªãch", "Hi·ªán Nh·∫≠p Th√¥ng S·ªë Giao D·ªãch");
        });
        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã ph·∫ßn trƒÉm
        function toggleActionSections(action) {
            const buyPercentages = document.getElementById("buyPercentages");
            const sellPercentages = document.getElementById("sellPercentages");
            const buyBtn = document.getElementById("buyBtn");
            const sellBtn = document.getElementById("sellBtn");

            buyPercentages.classList.toggle("hidden", action !== "buy");
            sellPercentages.classList.toggle("hidden", action !== "sell");

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa n√∫t buy/sell
            updateButtonSelection(action, buyBtn, sellBtn);
        }

        function updateButtonSelection(action, buyBtn, sellBtn) {
            if (action === "buy") {
                buyBtn.classList.add("selected");
                sellBtn.classList.remove("selected");
            } else if (action === "sell") {
                sellBtn.classList.add("selected");
                buyBtn.classList.remove("selected");
            } else {
                // N·∫øu kh√¥ng c√≥ action ch·ªçn, reset tr·∫°ng th√°i
                buyBtn.classList.remove("selected");
                sellBtn.classList.remove("selected");
            }
        }

        // Thi·∫øt l·∫≠p n√∫t Buy v√† Sell
        function setupActionButtons() {
            const buyBtn = document.getElementById("buyBtn");
            const sellBtn = document.getElementById("sellBtn");

            buyBtn.addEventListener("click", function () {
                toggleActionSections("buy"); // Hi·ªÉn th·ªã buyPercentages
                updateTokenValue(baseTokenValue, true); // T√≠nh to√°n d·ª±a tr√™n buyPercentages
            });

            sellBtn.addEventListener("click", function () {
                toggleActionSections("sell"); // Hi·ªÉn th·ªã sellPercentages
                updateTokenValue(baseTokenValue, false); // T√≠nh to√°n d·ª±a tr√™n sellPercentages
            });
        }

        function displayValue(value) {
            return value != null ? value : "Ch∆∞a nh·∫≠p";
        }

        async function loadTransactionDetails() {
            try {
                const response = await fetch("/params_action");
                const transactions = await response.json();

                if (transactions && transactions.length > 0) {
                    const transactionDetails = document.getElementById("transactionDetails");
                    transactionDetails.innerHTML = ""; // X√≥a n·ªôi dung c≈©

                    // L·∫∑p qua t·∫•t c·∫£ c√°c giao d·ªãch v√† th√™m th√¥ng tin
                    transactions.forEach((transaction, index) => {
                        const { privateKey, bundledTxArgs } = transaction;

                        // T·∫°o HTML cho t·ª´ng giao d·ªãch
                        const transactionHTML = `
                    <div class="transaction-item border-b pb-4 mb-4">
                        <p><strong>Giao D·ªãch ${index + 1}</strong></p>
                        <p><strong>Private Key:</strong> ${privateKey}</p>
                        <p><strong>H√†nh ƒê·ªông:</strong> ${displayValue(bundledTxArgs.action)}</p>
                        <p><strong>ƒê·ªãa Ch·ªâ Token (Mint):</strong> ${displayValue(bundledTxArgs.mint)}</p>
                        <p><strong>S·ªë L∆∞·ª£ng:</strong> ${displayValue(bundledTxArgs.amount)}</p>
                        <p><strong>Slippage:</strong> ${displayValue(bundledTxArgs.slippage)}</p>
                        <p><strong>Priority Fee:</strong> ${displayValue(bundledTxArgs.priorityFee)}</p>
                    </div>
                `;

                        // Th√™m HTML v√†o transactionDetails
                        transactionDetails.innerHTML += transactionHTML;
                    });
                } else {
                    console.log("Kh√¥ng c√≥ giao d·ªãch n√†o trong params_action.txt.");
                }
            } catch (error) {
                console.log("L·ªói khi t·∫£i th√¥ng tin giao d·ªãch:", error);
            }

            // N·∫øu c·∫ßn, g·ªçi loadParams ƒë·ªÉ c·∫≠p nh·∫≠t th√™m d·ªØ li·ªáu
            await loadParams();
        }

        let baseTokenValue = 0;
        // H√†m l·∫•y gi√° tr·ªã token
        async function loadToken() {
            try {
                const response = await fetch("/params");
                const data = await response.json();
                baseTokenValue = Math.floor(parseFloat(data.token));
                updateTokenValue(baseTokenValue, true); // G·ªçi h√†m ƒë·ªÉ hi·ªÉn th·ªã buyPercentages ban ƒë·∫ßu n·∫øu c·∫ßn
            } catch (error) {
                console.log("Kh√¥ng c√≥ d·ªØ li·ªáu.");
            }
        }
        // H√†m c·∫≠p nh·∫≠t h√†nh ƒë·ªông v√† thi·∫øt l·∫≠p l·∫°i giao di·ªán
        function updateAction(action) {
            console.log(`Selected action: ${action}`);
            toggleActionSections(action); // Hi·ªÉn th·ªã ƒë√∫ng giao di·ªán buy/sell

            // ƒê·∫∑t l·∫°i gi√° tr·ªã c·ªßa tr∆∞·ªùng amount v·ªÅ 0 khi thay ƒë·ªïi h√†nh ƒë·ªông
            const amountInput = document.getElementById("amount");
            if (amountInput) {
                amountInput.value = 0;
            }

            // C·∫≠p nh·∫≠t token theo h√†nh ƒë·ªông buy/sell
            const isBuy = action === 'buy';
            updateTokenValue(baseTokenValue, isBuy);
        }
        // H√†m t√≠nh to√°n token theo n√∫t nh·∫•n
        function updateTokenValue(token, isBuy = false) {
            const buyPercentages = document.getElementById("buyPercentages");
            const sellPercentages = document.getElementById("sellPercentages");

            let percentagesContainer = isBuy ? buyPercentages : sellPercentages;

            if (percentagesContainer) {
                const percentageButtons = percentagesContainer.querySelectorAll('[data-percentage]');

                // X√≥a t·∫•t c·∫£ s·ª± ki·ªán c≈© tr∆∞·ªõc khi g√°n s·ª± ki·ªán m·ªõi
                percentageButtons.forEach(button => {
                    const newButton = button.cloneNode(true); // T·∫°o m·ªôt b·∫£n sao c·ªßa button ƒë·ªÉ x√≥a s·ª± ki·ªán c≈©
                    button.replaceWith(newButton); // Thay th·∫ø button c≈© b·∫±ng b·∫£n sao

                    newButton.addEventListener('click', function () {
                        const percentage = parseFloat(newButton.dataset.percentage);

                        // N·∫øu l√† buy, s·ª≠ d·ª•ng gi√° tr·ªã tr·ª±c ti·∫øp trong data-percentage l√†m token t√≠nh to√°n
                        const calculatedToken = isBuy
                            ? percentage // S·ª≠ d·ª•ng gi√° tr·ªã tr·ª±c ti·∫øp trong data-percentage cho buy
                            : Math.floor(token * percentage); // T√≠nh token khi b√°n

                        console.log(`Token sau khi √°p d·ª•ng ${percentage * 100}% l√†: ${calculatedToken}`);

                        // Hi·ªÉn th·ªã gi√° tr·ªã token trong #tokenOutput
                        document.getElementById("tokenOutput").textContent = `Token: ${calculatedToken}`;

                        // T·ª± ƒë·ªông nh·∫≠p gi√° tr·ªã v√†o input #amount
                        const amountInput = document.getElementById("amount");
                        if (amountInput) {
                            amountInput.value = calculatedToken;
                        }
                    });
                });
            } else {
                console.log(`Ph·∫ßn t·ª≠ '${isBuy ? "buyPercentages" : "sellPercentages"}' kh√¥ng t·ªìn t·∫°i.`);
            }
        }

        async function loadParams() {
            try {
                // L·∫•y danh s√°ch giao d·ªãch t·ª´ params_action
                const actionResponse = await fetch("/params_action");
                const transactions = await actionResponse.json();

                if (transactions && transactions.length > 0) {
                    const keyDropdown = document.getElementById("key");
                    const selectedKey = keyDropdown.value;

                    // T√¨m giao d·ªãch li√™n quan ƒë·∫øn key ƒë∆∞·ª£c ch·ªçn
                    const selectedTransaction = transactions.find(tx => tx.privateKey === selectedKey);

                    const actionData = selectedTransaction?.bundledTxArgs || transactions[0].bundledTxArgs;

                    // C·∫≠p nh·∫≠t gi√° tr·ªã c√°c tr∆∞·ªùng input
                    document.getElementById("mint").value = actionData.mint || "";
                    // Hi·ªÉn th·ªã ph·∫ßn trƒÉm buy ho·∫∑c sell n·∫øu c√≥
                    toggleActionSections(actionData.action);  // G·ªçi toggleActionSections t√πy theo action (buy/sell)
                } else {
                    console.log("Kh√¥ng c√≥ d·ªØ li·ªáu trong params_action.txt.");
                }
            } catch (error) {
                console.log("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ params_action.txt:", error);
            }
        }


        window.onload = function () {
            loadParams();  // Function to load the necessary parameters
            loadTransactionDetails();  // Function to load the transaction details
            loadToken();  // Function to load the token
            setupActionButtons();  // Set up the action buttons for "Buy" and "Sell"
            toggleActionSections(action);
            updateAction(action);

        };

        // L∆∞u private keys
        document.getElementById("savePrivateKeys").addEventListener("click", async function () {
            const privateKeys = document.getElementById("privateKeys").value.trim().split("\n");

            // Ki·ªÉm tra xem privateKeys c√≥ tr·ªëng kh√¥ng
            if (privateKeys.length === 0 || privateKeys[0] === "") {
                alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt private key");
                return;
            }

            const response = await fetch("/nhapkey", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ privateKeys }),
            });

            const result = await response.text();
            alert(result);
        });

        document.getElementById("saveThongSo").addEventListener("click", async function () {
            const keyDropdown = document.getElementById("key");
            const selectedKey = keyDropdown.value; // L·∫•y gi√° tr·ªã key t·ª´ dropdown
            const isKeyFull = selectedKey === "keyfull"; // Ki·ªÉm tra ch·∫ø ƒë·ªô Key Full

            const action = document.querySelector(".action-btn.selected")?.dataset.action || "";
            const mint = document.getElementById("mint").value.trim();
            const amount = parseFloat(document.getElementById("amount").value.trim());
            const slippage = parseFloat(document.getElementById("slippage").value.trim());
            const priorityFee = parseFloat(document.getElementById("priorityFee").value.trim());
            const denominatedInSol = document.getElementById("denominatedInSol").value.trim();

            if (!action || !mint || isNaN(amount) || isNaN(slippage) || isNaN(priorityFee) || !denominatedInSol) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng s·ªë giao d·ªãch.");
                return;
            }

            try {
                if (isKeyFull) {
                    // Key Full: G·ª≠i th√¥ng s·ªë giao d·ªãch cho t·∫•t c·∫£ keys
                    const response = await fetch("/params_key");
                    const keys = await response.json();

                    const payload = keys.map(key => ({
                        privateKey: key,
                        bundledTxArgs: { action, mint, amount, slippage, priorityFee, denominatedInSol, pool: "pump" },
                    }));

                    await sendTransactionData(payload);
                } else {
                    // T·ª´ng Key: G·ª≠i th√¥ng s·ªë giao d·ªãch cho key ƒë∆∞·ª£c ch·ªçn
                    const payload = [{
                        privateKey: selectedKey,
                        bundledTxArgs: { action, mint, amount, slippage, priorityFee, denominatedInSol, pool: "pump" },
                    }];

                    await sendTransactionData(payload);
                }
            } catch (error) {
                console.error("L·ªói khi l∆∞u th√¥ng s·ªë giao d·ªãch:", error);
                alert("Kh√¥ng th·ªÉ l∆∞u th√¥ng s·ªë giao d·ªãch.");
            }
        });

        async function sendTransactionData(payload) {
            const response = await fetch("/nhapthongso", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                alert("Th√¥ng s·ªë giao d·ªãch ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!");
                loadTransactionDetails();
            } else {
                const result = await response.text();
                alert(`L·ªói: ${result}`);
            }
        }


        document.getElementById("tradeButton").addEventListener("click", async function () {
            // Display loading message
            document.getElementById("resultLog").innerHTML = "ƒêang th·ª±c hi·ªán giao d·ªãch...";

            try {
                const response = await fetch("/trade", { method: "POST" });
                if (!response.ok) throw new Error("Giao d·ªãch th·∫•t b·∫°i");
                const result = await response.text();
                document.getElementById("resultLog").innerHTML = result.replace(
                    /(https?:\/\/\S+)/g,
                    '<a href="$1" target="_blank">$1</a>'
                );
            } catch (error) {
                document.getElementById("resultLog").innerHTML = `L·ªói: ${error.message}`;
            }

        });


        document.getElementById('getTokenButton').addEventListener('click', async function () {
            try {
                const response = await fetch('/viewtoken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getToken'
                    })
                });

                if (!response.ok) {
                    throw new Error('C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu token');
                }

                const data = await response.json();

                if (data.details && data.details.length > 0) {
                    let htmlContent = '<div class="token-list">';

                    data.details.forEach((wallet, index) => {
                        htmlContent += `<div class="wallet-item">`;
                        htmlContent += `<p>üìò V√≠ ${index + 1}: <strong>${wallet.address}</strong></p>`;

                        if (wallet.tokens && wallet.tokens.length > 0) {
                            wallet.tokens.forEach(token => {
                                const formattedBalance = parseFloat(token.balance).toLocaleString('en-US', {
                                    minimumFractionDigits: 6,
                                    maximumFractionDigits: 6
                                });
                                htmlContent += `
                            <p class="token-details">
                                ‚Ä¢ S·ªë d∆∞: <strong>${formattedBalance} </strong><br>
                                ‚Ä¢ Mint: ${token.mint}
                            </p>
                        `;
                            });
                        } else if (wallet.error) {
                            htmlContent += `<p class="error-message">‚ùå L·ªói: ${wallet.error}</p>`;
                        } else {
                            htmlContent += `<p class="no-token-message">‚ùå Kh√¥ng c√≥ token</p>`;
                        }

                        htmlContent += `</div>`;
                    });

                    htmlContent += '</div>';
                    document.getElementById('resultLog1').innerHTML = htmlContent;

                    // L∆∞u th√¥ng tin token c·ªßa t·∫•t c·∫£ v√≠
                    const allTokens = data.details
                        .filter(wallet => wallet.tokens && wallet.tokens.length > 0)
                        .map(wallet => wallet.tokens[0].balance)
                        .map(balance => parseFloat(balance));

                    if (allTokens.length > 0) {
                        await saveTokenToFile(allTokens);
                    }
                } else {
                    document.getElementById('resultLog1').innerHTML = 'Kh√¥ng t√¨m th·∫•y token trong v√≠';
                }

            } catch (error) {
                console.error(error);
                document.getElementById('resultLog1').innerHTML = 'C√≥ l·ªói x·∫£y ra khi l·∫•y token';
            }
        });

        async function saveTokenToFile(token) {
            try {
                const response = await fetch('/savetoken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                if (!response.ok) {
                    throw new Error('C√≥ l·ªói khi l∆∞u token');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'C√≥ l·ªói khi l∆∞u token');
                }

            } catch (error) {
                console.error('Error saving token:', error);
                throw error;
            }
        }

        document.getElementById("clearAll").addEventListener("click", async () => {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·∫øt th√¥ng s·ªë giao d·ªãch?")) {
                try {
                    const response = await fetch("/clear_params_action", { method: "DELETE" });

                    console.log("K·∫øt qu·∫£ t·ª´ server:", response);

                    if (response.ok) {
                        alert("T·∫•t c·∫£ th√¥ng s·ªë giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√≥a.");
                        document.getElementById("transactionDetails").innerHTML = ""; // X√≥a giao di·ªán
                    } else {
                        const error = await response.text();
                        console.error("L·ªói t·ª´ server:", error);
                        alert(`Kh√¥ng th·ªÉ x√≥a th√¥ng s·ªë giao d·ªãch: ${error}`);
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a th√¥ng s·ªë giao d·ªãch:", error);
                    alert("Kh√¥ng th·ªÉ x√≥a th√¥ng s·ªë giao d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            }
        });


    </script>

</body>

</html>